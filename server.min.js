var $jscomp={scope:{}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,d){if(d.get||d.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[b]=d.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.symbolCounter_=0;$jscomp.Symbol=function(a){return $jscomp.SYMBOL_PREFIX+(a||"")+$jscomp.symbolCounter_++};
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(a){var b=0;return $jscomp.iteratorPrototype(function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};$jscomp.array=$jscomp.array||{};$jscomp.iteratorFromArray=function(a,b){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var d=0,c={next:function(){if(d<a.length){var e=d++;return{value:b(e,a[e]),done:!1}}c.next=function(){return{done:!0,value:void 0}};return c.next()}};c[Symbol.iterator]=function(){return c};return c};
$jscomp.polyfill=function(a,b,d,c){if(b){d=$jscomp.global;a=a.split(".");for(c=0;c<a.length-1;c++){var e=a[c];e in d||(d[e]={});d=d[e]}a=a[a.length-1];c=d[a];b=b(c);b!=c&&null!=b&&$jscomp.defineProperty(d,a,{configurable:!0,writable:!0,value:b})}};$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(b){return b})}},"es6-impl","es3");
var express=require("express"),app=express(),router=express.Router(),http=require("http").Server(app),path=require("path"),io=require("socket.io")(http),port=process.env.PORT||3E3,_=require("underscore"),users=[],teams=[],server=null,os=require("os"),ifaces=os.networkInterfaces(),ip_config=get_ip_config(),spawn=require("child_process").spawn,cp=require("child_process"),Omx=require("node-omxplayer"),video_player=null;$=require("jquery");var http2=require("http"),fs=require("fs");module.exports=router;
app.use(express["static"]("./src"));app.get("*",function(a,b){b.sendFile("njoy/src/index.html",{root:path.join(__dirname,"../")})});
io.on("connection",function(a){console.log("a user connected");a.on("disconnect",function(){console.log("user disconnected")});a.on("njoy",function(b){users_activities.push(b);b=addParams(b);var a={},c="njoy";switch(b.status){case "reboot":cp.exec("/home/pi/njoy/startchromium.sh",function(a,b,c){console.log("stdout: "+b);console.log("stderr: "+c);null!==a&&console.log("exec errror: "+a)});case "success":break;case "fail":break;case "connect":a=login(b);b=addParams(b);io.emit("njoy_"+b.uuid,{status:a.status,
infos:a,datas:b});c="njoy";break;case "disconnect":a=logout(b);b=addParams(b);break;case "activities":a.status="activities";b.users_activities=users_activities;break;case "message":a.status="message";break;case "launch_content":a.status="launch_content";break;case "teams":a.status="teams";b.teams=teams;break;case "new_team":0<_.where(teams,{label:b.new_team.label}).length?(a.status="error",b.title="teams",b.message="le nom de la team existe d\u00e9j\u00e0"):(b.new_team.color=getRandomColor(),teams.push(b.new_team),
a.status="teams",b.teams=teams);break;case "delete_team":"undefined"!==typeof teams[b.id]&&(delete teams[b.id],teams.splice(b.id,1));a.status="teams";b.teams=teams;break;case "team_score":"undefined"!==typeof teams[b.id]&&(teams[b.id].score=b.score);a.status="teams";b.teams=teams;break;default:a="undefined"!==typeof b.status?{status:b.status}:{status:"default"}}"pause_video"===b.status&&(null!==video_player&&(video_player.pause(),io.emit(c,{status:"video_pause",is_running:video_player.running})),
console.log("video_player pause ",video_player));"play_video"===b.status&&null!==video_player&&(video_player.play(),io.emit(c,{status:"video_play",is_running:video_player.running}));"mute_video"===b.status&&null!==video_player&&(video_player.volDown(),video_player.volDown(),video_player.volDown(),video_player.volDown(),video_player.volDown(),video_player.volDown(),video_player.volDown(),video_player.volDown(),video_player.volDown(),video_player.volDown(),io.emit(c,{status:"video_muted",is_running:video_player.running}));
"audio_video"===b.status&&null!==video_player&&(video_player.volUp(),video_player.volUp(),video_player.volUp(),video_player.volUp(),video_player.volUp(),video_player.volUp(),video_player.volUp(),video_player.volUp(),video_player.volUp(),video_player.volUp(),io.emit(c,{status:"video_audio",is_running:video_player.running}));"fast_forward_video"===b.status&&null!==video_player&&(video_player.fwd30(),io.emit(c,{status:"fast_forward_video",is_running:video_player.running}));"fast_backward_video"===b.status&&
null!==video_player&&(video_player.back30(),io.emit(c,{status:"fast_backward_video",is_running:video_player.running}));"stop_video"===b.status&&(console.log(video_player),console.log(typeof video_player),null!==video_player&&(console.log("video_player not null"),video_player.quit(),console.log("video_player not null after quit"),video_player=null,console.log("emit"),io.emit(c,{status:"video_closed"})),cp.exec("export DISPLAY=:0",function(a,b,c){}),io.emit(c,{status:"kill_vid"}));if("video"===b.status)if(null!==
video_player)video_player.quit(),video_player=null,cp.exec("export DISPLAY=:0",function(a,b,c){}),io.emit(c,{status:"kill_vid"});else{console.log("demande de video");if(null!==video_player)return console.log("video en cours"),video_player.quit(),video_player=null,console.log("on quitte la video en cours"),!1;console.log("on set l \u00e9cran");cp.exec("export DISPLAY=:0",function(a,b,c){});console.log("on lance la vid\u00e9o");video_player=Omx("http://10.3.141.1:3000/"+b.file,"local",!1,1);video_player.volUp();
video_player.play();video_player.on("close",function(){console.log("la video est termin\u00e9e");io.emit(c,{status:"video_closed"});video_player=null});io.emit(c,{status:"video_started"})}else-1===b.status.indexOf("video")&&null!==video_player&&(video_player.quit(),video_player=null);io.emit(c,{status:a.status,infos:a,datas:b})});a.on("chat message",function(a){io.emit("chat message",a)})});
http.listen(port,function(){cp.exec("/home/pi/njoy/startchromium.sh",function(a,b,d){console.log("stdout: "+b);console.log("stderr: "+d)})});
var login=function(a){"undefined"===typeof users&&(users=[]);if(0<_.where(users,{user_name:a.user_name}).length)return{status:"login_error",message:"need uniq pseudo"};users.push({user_name:a.user_name,uuid:a.uuid});0===_.where(users,{regis:"true"}).length&&(users[users.length-1].regis="true");return{status:"login_success",message:"success login",users:users}},logout=function(a){require("underscore");users=_.without(users,_.findWhere(users,{uuid:a.uuid}));return{status:"logout_success",message:"success lougout"}},
addParams=function(a){"undefined"===typeof a&&(a={});a.users=users;a.teams=teams;a.animations=animations;a.ip_config=get_ip_config();return a};function get_ip_config(){Object.keys(ifaces).forEach(function(a){ifaces[a].forEach(function(a){if("IPv4"===a.family&&!1===a.internal)return a.address})})}function getRandomColor(){for(var a="#",b=0;6>b;b++)a+="0123456789ABCDEF"[Math.floor(16*Math.random())];return a}var users_activities=[],animations=null;
