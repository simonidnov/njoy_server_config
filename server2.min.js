function get_ip_config(){Object.keys(ifaces).forEach(function(e){ifaces[e].forEach(function(e){if("IPv4"===e.family&&!1===e.internal)return e.address})})}function getRandomColor(){for(var e="#",s=0;s<6;s++)e+="0123456789ABCDEF"[Math.floor(16*Math.random())];return e}function resetProgressListener(){video_is_playing=!0,playerTimer=setTimeout(function(){sendOmxStatus()},500)}function sendOmxStatus(){if(video_is_playing){var e={status:"progress_video",position:omx.getCurrentPosition(),duration:omx.getCurrentDuration(),volume:omx.getCurrentVolume()};omx.getCurrentPosition()>0&&omx.getCurrentPosition()>=omx.getCurrentDuration()?io.emit("njoy",{status:"stop_video"}):(io.emit("njoy",e),playerTimer=setTimeout(function(){sendOmxStatus()},500))}}function resetAudioProgressListener(){audio_is_playing=!0,playerTimer=setTimeout(function(){sendOmxAudioStatus()},500)}function sendOmxAudioStatus(){if(audio_is_playing){var e={status:"progress_audio",position:omx.getCurrentPosition(),duration:omx.getCurrentDuration(),volume:omx.getCurrentVolume()};omx.getCurrentPosition()>0&&omx.getCurrentPosition()>=omx.getCurrentDuration()?io.emit("njoy",{status:"stop_audio"}):(io.emit("njoy",e),playerTimer=setTimeout(function(){sendOmxAudioStatus()},500))}}const express=require("express"),app=express(),router=express.Router(),http=require("http").Server(app),path=require("path"),io=require("socket.io")(http),port=process.env.PORT||3e3,_=require("underscore"),users=[],teams=[],server=null,os=require("os"),ifaces=os.networkInterfaces(),ip_config=get_ip_config(),spawn=require("child_process").spawn,cp=require("child_process"),video_player=null,$=require("jquery"),http2=require("http"),fs=require("fs"),users_activities=[],animations=null,playerTimer=null,app_volume=1;var omx=require("omx-interface"),omx_options={audioOutput:"local",blackBackground:!0,disableKeys:!0,disableOnScreenDisplay:!0};omx_audio_options={audioOutput:"local",blackBackground:!1,disableKeys:!0,disableOnScreenDisplay:!0},omx.init_remote({port:8080}),module.exports=router,app.use(express.static("./src")),app.get("*",function(e,s){s.sendFile("njoy/src/index.html",{root:path.join(__dirname,"../")})}),io.on("connection",function(s){console.log("a user connected"),s.on("disconnect",function(){console.log("user disconnected")}),s.on("njoy",function(s){users_activities.push(s),s=addParams(s);var t={},o="njoy";switch(console.log("datas.status ::::::: ",s.status),s.status){case"reboot":cp.exec("/home/pi/njoy/startchromium.sh",function(e,s,t){});case"success":case"fail":break;case"connect":t=login(s),s=addParams(s),io.emit("njoy_"+s.uuid,{status:t.status,infos:t,datas:s}),o="njoy";break;case"disconnect":t=logout(s),s=addParams(s);break;case"activities":t.status="activities",s.users_activities=users_activities;break;case"message":t.status="message";break;case"launch_content":t.status="launch_content";break;case"teams":t.status="teams",s.teams=teams;break;case"new_team":_.where(teams,{label:s.new_team.label}).length>0?(t.status="error",s.title="teams",s.message="le nom de la team existe déjà"):(s.new_team.color=getRandomColor(),teams.push(s.new_team),t.status="teams",s.teams=teams);break;case"delete_team":void 0!==teams[s.id]&&(delete teams[s.id],teams.splice(s.id,1)),t.status="teams",s.teams=teams;break;case"team_score":void 0!==teams[s.id]&&(teams[s.id].score=s.score),t.status="teams",s.teams=teams;break;case"video":"undefined"!=typeof video_is_playing&&video_is_playing?(omx.quit(),video_is_playing=!1,null!==playerTimer&&(clearTimeout(playerTimer),playerTimer=null),io.emit(o,{status:"video_stopped"}),io.emit(o,{status:"error",datas:{title:"video",message:"Une vidéo était en cours de lecture et vient d'être coupée."}})):(video_is_playing=!1,omx.quit(),setTimeout(function(){cp.exec("export DISPLAY=:0",function(e,s,t){}),omx.open("http://10.3.141.1:3000/"+s.file,omx_options),omx.setVolume(app_volume),io.emit(o,{status:"video_started",duration:omx.getCurrentDuration(),position:omx.getCurrentPosition()}),resetProgressListener()},200));break;case"pause_video":omx.pause(),io.emit(o,{status:"video_pause",is_running:null,is_loaded:null});break;case"resume_video":omx.play(),io.emit(o,{status:"video_resume",is_running:null,is_loaded:null});break;case"play_video":omx.play(),io.emit(o,{status:"video_play",is_running:null,is_loaded:null});break;case"volume_video":omx.setVolume(s.volume),app_volume=s.volume,io.emit(o,{status:"video_volume",volume:s.volume});break;case"seek_video":omx.seek(s.seek),io.emit(o,{status:"video_seek",seek:s.seek});break;case"position_video":omx.setPosition(s.position),io.emit(o,{status:"video_position",position:s.position});break;case"stop_video":omx.quit(),video_is_playing=!1,null!==playerTimer&&(clearTimeout(playerTimer),playerTimer=null),io.emit(o,{status:"video_stopped"});break;case"audio":"undefined"!=typeof audio_is_playing&&audio_is_playing?(omx.quit(),audio_is_playing=!1,null!==playerTimer&&(clearTimeout(playerTimer),playerTimer=null),io.emit(o,{status:"audio_stopped"}),io.emit(o,{status:"error",datas:{title:"audio",message:"Un mp3 était en cours de lecture et vient d'être coupée."}})):(omx.quit(),setTimeout(function(){audio_is_playing=!1,cp.exec("export DISPLAY=:0",function(e,s,t){}),omx.open("http://10.3.141.1:3000/"+s.file,omx_audio_options),omx.setVolume(app_volume),io.emit(o,{status:"audio_started",duration:omx.getCurrentDuration(),position:omx.getCurrentPosition()}),resetAudioProgressListener()},200));break;case"pause_audio":omx.pause(),io.emit(o,{status:"audio_pause",is_running:null,is_loaded:null});break;case"resume_audio":omx.play(),io.emit(o,{status:"audio_resume",is_running:null,is_loaded:null});break;case"play_audio":omx.play(),io.emit(o,{status:"audio_play",is_running:null,is_loaded:null});break;case"volume_audio":omx.setVolume(s.volume),app_volume=s.volume,io.emit(o,{status:"audio_volume",volume:s.volume});break;case"seek_audio":omx.seek(s.seek),io.emit(o,{status:"audio_seek",seek:s.seek});break;case"position_audio":omx.setPosition(s.position),io.emit(o,{status:"audio_position",position:s.position});break;case"stop_audio":omx.quit(),audio_is_playing=!1,null!==playerTimer&&(clearTimeout(playerTimer),playerTimer=null),io.emit(o,{status:"audio_stopped"});break;default:t=void 0!==s.status?{status:s.status}:{status:"default"}}-1!==e.status.indexOf("video")&&-1!==e.status.indexOf("audio")||(io.emit(o,{status:"stop_audio"}),io.emit(o,{status:"stop_video"})),io.emit(o,{status:t.status,infos:t,datas:s})}),s.on("chat message",function(e){io.emit("chat message",e)})}),http.listen(port,function(){cp.exec("/home/pi/njoy/startchromium.sh",function(e,s,t){null!==e&&console.log("exec errror: "+e)})});var login=function(e){return void 0===users&&(users=[]),_.where(users,{user_name:e.user_name}).length>0?{status:"login_error",message:"need uniq pseudo"}:(users.push({user_name:e.user_name,uuid:e.uuid}),0===_.where(users,{regis:"true"}).length&&(users[users.length-1].regis="true"),{status:"login_success",message:"success login",users:users})},logout=function(e){return require("underscore"),users=_.without(users,_.findWhere(users,{uuid:e.uuid})),{status:"logout_success",message:"success lougout"}},addParams=function(e){return void 0===e&&(e={}),e.users=users,e.teams=teams,e.animations=null,e.ip_config=get_ip_config(),e};