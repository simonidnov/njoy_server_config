function get_ip_config(){Object.keys(ifaces).forEach(function(e){ifaces[e].forEach(function(e){if("IPv4"===e.family&&!1===e.internal)return e.address})})}function getRandomColor(){for(var e="#",s=0;s<6;s++)e+="0123456789ABCDEF"[Math.floor(16*Math.random())];return e}const express=require("express"),app=express(),router=express.Router(),http=require("http").Server(app),path=require("path"),io=require("socket.io")(http),port=process.env.PORT||3e3,_=require("underscore"),users=[],teams=[],server=null,os=require("os"),ifaces=os.networkInterfaces(),ip_config=get_ip_config(),spawn=require("child_process").spawn,cp=require("child_process"),video_player=null,$=require("jquery"),http2=require("http"),fs=require("fs"),users_activities=[],animations=null;var omx=require("omxdirector");omx.on("load",function(e,s){io.emit(call,{status:"load_vid"})}),omx.on("play",function(){io.emit(call,{status:"play_vid"})}),omx.on("changeVideo",function(e){io.emit(call,{status:"change_vid",name:e})}),omx.on("pause",function(){io.emit(call,{status:"pause_vid"})}),omx.on("stop",function(){io.emit(call,{status:"kill_vid"})}),module.exports=router,app.use(express.static("./src")),app.get("*",function(e,s){s.sendFile("njoy/src/index.html",{root:path.join(__dirname,"../")})}),io.on("connection",function(e){console.log("a user connected"),e.on("disconnect",function(){console.log("user disconnected")}),e.on("njoy",function(e){users_activities.push(e),e=addParams(e);var s={},t="njoy";switch(e.status){case"reboot":cp.exec("/home/pi/njoy/startchromium.sh",function(e,s,t){});case"success":case"fail":break;case"connect":s=login(e),e=addParams(e),io.emit("njoy_"+e.uuid,{status:s.status,infos:s,datas:e}),t="njoy";break;case"disconnect":s=logout(e),e=addParams(e);break;case"activities":s.status="activities",e.users_activities=users_activities;break;case"message":s.status="message";break;case"launch_content":s.status="launch_content";break;case"teams":s.status="teams",e.teams=teams;break;case"new_team":_.where(teams,{label:e.new_team.label}).length>0?(s.status="error",e.title="teams",e.message="le nom de la team existe déjà"):(e.new_team.color=getRandomColor(),teams.push(e.new_team),s.status="teams",e.teams=teams);break;case"delete_team":void 0!==teams[e.id]&&(delete teams[e.id],teams.splice(e.id,1)),s.status="teams",e.teams=teams;break;case"team_score":void 0!==teams[e.id]&&(teams[e.id].score=e.score),s.status="teams",e.teams=teams;break;default:s=void 0!==e.status?{status:e.status}:{status:"default"}}if("pause_video"===e.status&&(omx.pause(),io.emit(t,{status:"video_pause",is_running:omx.isPlaying(),is_loaded:omx.isLoaded()})),"play_video"===e.status&&(omx.play(),io.emit(t,{status:"video_play",is_running:omx.isPlaying(),is_loaded:omx.isLoaded()})),"mute_video"===e.status&&(omx.voldown(),io.emit(t,{status:"video_muted",is_running:omx.isPlaying(),is_loaded:omx.isLoaded()})),"audio_video"===e.status&&(omx.volup(),io.emit(t,{status:"video_audio",is_running:omx.isPlaying(),is_loaded:omx.isLoaded()})),"fast_forward_video"===e.status&&io.emit(t,{status:"fast_backward_video",is_running:omx.isPlaying(),is_loaded:omx.isLoaded(),message:"fast backward is on dev"}),"fast_backward_video"===e.status&&io.emit(t,{status:"fast_backward_video",is_running:omx.isPlaying(),is_loaded:omx.isLoaded(),message:"fast backward is on dev"}),"stop_video"===e.status&&(omx.stop(),io.emit(t,{status:"kill_vid"})),"video"===e.status){var a=omx.getStatus();(a.loaded||omx.isPlaying())&&omx.stop(),a.playing&&console.log("video is playing ",a.videos,a.settings),cp.exec("export DISPLAY=:0",function(e,s,t){}),omx.play("http://10.3.141.1:3000/"+e.file,{audioOutput:"local"}),omx.volup(),io.emit(t,{status:"video_started",is_running:omx.isPlaying(),is_loaded:omx.isLoaded()})}else-1===e.status.indexOf("video")&&omx.stop();io.emit(t,{status:s.status,infos:s,datas:e})}),e.on("chat message",function(e){io.emit("chat message",e)})}),http.listen(port,function(){cp.exec("/home/pi/njoy/startchromium.sh",function(e,s,t){null!==e&&console.log("exec errror: "+e)})});var login=function(e){return void 0===users&&(users=[]),_.where(users,{user_name:e.user_name}).length>0?{status:"login_error",message:"need uniq pseudo"}:(users.push({user_name:e.user_name,uuid:e.uuid}),0===_.where(users,{regis:"true"}).length&&(users[users.length-1].regis="true"),{status:"login_success",message:"success login",users:users})},logout=function(e){return require("underscore"),users=_.without(users,_.findWhere(users,{uuid:e.uuid})),{status:"logout_success",message:"success lougout"}},addParams=function(e){return void 0===e&&(e={}),e.users=users,e.teams=teams,e.animations=null,e.ip_config=get_ip_config(),e};