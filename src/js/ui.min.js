var ui={templates:{header:null,footer:null},page_params:{page:"default",params:{}},init:function(){this.load_templates(),this.setListeners()},load_templates:function(){_.each(_.keys(this.templates),function(e,t){$.get("views/"+e+".tmpl",$.proxy(function(t){ui.templates[e]=_.template(t)},this))}),0===$("#ui_layer").length&&$("body").append('<div class="ui_layer" id="ui_layer"></div>'),0===$("#ui_templates").length&&($("body").append('<div class="ui_templates" id="ui_templates"></div>'),$.get("views/ui/popin.tmpl",$.proxy(function(e){ui.templates.popin=_.template(e)},this)),$.get("views/ui/notification.tmpl",$.proxy(function(e){ui.templates.notification=_.template(e)},this))),setTimeout($.proxy(function(){$("body").append(this.templates.header({})),$("body").append(this.templates.footer({})),this.navigate(window.location.pathname),this.setListeners()},this),200)},test_popin:function(){ui.popin({illus:"url",title:"test",message:"message test",buttons:[{label:"button 1"},{label:"button 2"}]},function(e){console.log(e)})},popin:function(e,t){$("#popin_ui_content").length>0&&$("#popin_ui_content").remove(),ui.popin_callBack=t,$("body").append(ui.templates.popin(e)),$("#popin_ui_content .popin").css("top","100%"),TweenMax.to($("#popin_ui_content .popin"),.5,{top:0,ease:Back.easeOut}),$("[data-popbutton]").on("click",function(e){ui.close_popin($(this).attr("data-popbutton"))}),$("#close_popin").on("click",function(){ui.close_popin()})},close_popin:function(e){TweenMax.to($("#popin_ui_content .popin"),.5,{top:"100%",opacity:0,ease:Back.easeIn}),TweenMax.to($("#popin_ui_content"),.5,{opacity:0,delay:.5,onComplete:function(){$("#popin_ui_content").remove()}}),ui.popin_callBack(e)},setListeners:function(){$("[data-navigate]").off("click").on("click",function(e){return void 0!==$(this).attr("data-direction")&&(ui.direction=$(this).attr("data-direction")),ui.navigate($(this).attr("data-navigate")),e.preventDefault(),!1}),$("[data-action]").off("click").on("click",function(){switch($(this).attr("data-action")){case"cast":var e={};void 0!==$(this).attr("data-type")&&(e.status=$(this).attr("data-type")),void 0!==$(this).attr("data-file")&&(e.file=$(this).attr("data-file")),void 0!==$(this).attr("data-menu")&&(e.menu=$(this).attr("data-menu")),void 0!==$(this).attr("data-component")&&(e.component=$(this).attr("data-component")),void 0!==$(this).attr("data-componentid")&&(e.component_id=$(this).attr("data-componentid")),void 0!==$(this).attr("data-chronos")&&(e.chronos=$(this).attr("data-chronos")),void 0!==$(this).attr("data-chronostype")&&(e.chronos_type=$(this).attr("data-chronostype")),e.tools=app.selected_tool,app.socket.emit("njoy",e),$(".choices").css("display","none"),$(this).parent().find(".choices").length>0&&$(this).parent().find(".choices").css("display","block");break;case"response":$(this).addClass("checked"),app.socket.emit("njoy",{status:$(this).attr("data-type"),response:$(this).attr("data-id"),type:$(this).attr("data-type")})}app_tools.components_scroll.refresh()})},navigate:function(e){if(app.socket_callback=null,app.socket_callback=function(e){console.log(e)},-1!==e.indexOf("logout"))return ui.popin({illus:"img/logout_illus.svg",title:"Déconnexion",message:"Si vous continuez vous allez vous déconnecter du serveur.<br/>Êtes vous certain de vouloir continuer ?",buttons:[{label:"Annuler"},{label:"Déconnexion",class:"error"}]},function(e){1===parseInt(e)&&ui.navigate("/")}),!1;window.history.pushState("","",e),this.setParams(e),this.load_dependencies()},load_dependencies:function(){""===this.page_params.page?this.page_params.page="default":this.page_params.page=this.page_params.page,$.get("/pages/"+this.page_params.page+"/descriptor.json",function(e){ui.descriptor=e,$.get("pages/"+ui.page_params.page+"/"+ui.descriptor.content.uri,function(e){$("body").append('<div class="blocker"></div>'),ui.templates[ui.page_params.page]=_.template(e),$("body main.app").append(ui.templates[ui.page_params.page](ui.descriptor.content.datas)),$("body main.app .screen").last().css("left","100%");for(var t=0;t<ui.descriptor.dependencies.css.length;t++)if(0===$('link[href="pages/'+ui.page_params.page+"/"+ui.descriptor.dependencies.css[t]+'"]').length){var a=document.getElementsByTagName("head")[0],i=document.createElement("link");i.rel="stylesheet",i.type="text/css",i.href="pages/"+ui.page_params.page+"/"+ui.descriptor.dependencies.css[t],i.media="all",a.appendChild(i)}for(var n=0;n<ui.descriptor.dependencies.js.length;n++)$.getScript("pages/"+ui.page_params.page+"/"+ui.descriptor.dependencies.js[n],function(e){});$.getScript("pages/"+ui.page_params.page+"/"+ui.descriptor.class+".js",function(e){$("body main.app .screen").length>1?("back"===ui.direction?(TweenMax.to($("body main.app .screen").first(),.5,{left:"100%",ease:Power4.easeInOut}),TweenMax.set($("body main.app .screen").last(),{left:"-100%"})):TweenMax.to($("body main.app .screen").first(),.5,{left:"-100%",ease:Power4.easeInOut}),TweenMax.to($("body main.app .screen").last(),.5,{left:"0%",ease:Power4.easeInOut,onComplete:function(){window[ui.descriptor.class].init(),$("body main.app .screen").first().remove(),ui.init_scroll_view(),$(".blocker").remove()}}),ui.direction=""):($("body main.app .screen").last().css("left","0%"),window[ui.descriptor.class].init(),$(".blocker").remove(),ui.init_scroll_view())}),_.isUndefined(ui.descriptor.header)||!0!==ui.descriptor.header.display?$("header").css("top","-80px").remove(".header-navbar"):($("header").css("top","0px"),ui.init_navbar()),!0!==ui.descriptor.footer.display?$("footer").css("bottom","-80px"):$("footer").css("bottom","0px"),ui.setListeners()})})},display_error:function(e){$(".ui_layer").append(ui.templates.notification(e)),$(".cross_close").off("click").on("click",function(){$(this).parent().remove()})},setParams:function(e){e=e.replace("/","").split("/"),this.page_params.page=e[0],this.page_params.params={};for(var t=1;t<e.length;t+=2)this.page_params.params[e[t]]=e[t+1]},init_navbar:function(){if(void 0!==ui.descriptor.header.nav_left){$("header .left_nav").remove();for(var e=0;e<ui.descriptor.header.nav_left.length;e++)$("header").append('<div class="left_nav"><div class="head_button" data-navigate="'+ui.descriptor.header.nav_left[e].link+'"><div class="icon" style="background-image:url(img/'+ui.descriptor.header.nav_left[e].icon+'.svg);"></div><span>'+ui.descriptor.header.nav_left[e].label+"</span></div></div>"),void 0!==ui.descriptor.header.nav_left[e].direction&&$('[data-navigate="'+ui.descriptor.header.nav_left[e].link+'"]').attr("data-direction",ui.descriptor.header.nav_left[e].direction)}!_.isUndefined(ui.descriptor.header.tab_bar)&&ui.descriptor.header.tab_bar.length>0&&$.get("views/header-navbar.tmpl",$.proxy(function(e){function t(){$("header .select_bar").css({width:$(".header-navbar ul li.selected").first().outerWidth(),left:$(".header-navbar ul li.selected").first().position().left})}var a=_.template(e);$("header").append(a(ui.descriptor.header)),$("header .select_bar").css({width:$(".header-navbar ul li").first().width(),left:$(".header-navbar ul li").first().position().left}),t(),$("header .header-navbar li").off("click").on("click",function(){$("header .header-navbar li").removeClass("selected"),$(this).addClass("selected"),t()}),ui.navbar_scroll=new IScroll("#header_navbar_wrapper",{mouseWheel:!0,click:!0,useTransition:!0})},this))},init_scroll_view:function(){$(".screen").css({height:window.innerHeight-$("header").height(),overflow:"hidden"}),$(".screen .wrapper").css({height:"100%",width:"100%",overflow:"hidden"}),$(".screen .wrapper .scroller").css({display:"table",width:"100%"}),1===$(".screen .wrapper .scroller").length&&"undefined"!=typeof IScroll&&(ui.page_scroll=new IScroll("#screen_wrapper",{mouseWheel:!0,click:!0,useTransition:!0}))}};